<!DOCTYPE html>
<html>
<head>
    <title>WMPR Requests Settings</title>
    <meta name="decorator" content="atl.general">
    <meta name="admin.active.section" content="atl.jira.proj.config">
    <meta name="admin.active.tab" content="wmpr-settings-menu">
    <meta name="projectkey" content="$projectKey">
    <meta charset="utf-8">
    
    #set($webResourceManager = $action.webResourceManager)
    $webResourceManager.requireResource("com.scriptrunnerhq.vendors-api.backend:wmpr-settings-resources")
    $webResourceManager.requireResource("com.atlassian.auiplugin:ajs")
    $webResourceManager.requireResource("com.atlassian.plugins.jquery:jquery")
    $webResourceManager.requireResource("jira.webresources:jira-global")
    $webResourceManager.requireResource("com.atlassian.jira.jira-project-config-plugin:project-config")
</head>
<body>
    <div class="aui-page-panel">
        <div class="aui-page-panel-inner">
            <div class="aui-page-panel-nav" id="project-config-panel-nav">
                <!-- Project admin navigation will be injected here by Jira -->
            </div>
            
            <div class="aui-page-panel-content">
                <header class="aui-page-header">
                    <div class="aui-page-header-inner">
                        <div class="aui-page-header-main">
                            <h1>WMPR Requests Settings</h1>
                            <p class="aui-page-header-description">
                                Configure the JQL query used to fetch WMPR requests for display in the Service Desk portal.
                            </p>
                        </div>
                    </div>
                </header>
                
                <div class="aui-page-panel-content-body">
                    <div id="wmpr-settings-container" class="project-config-content">
                        <!-- Loading state while React component initializes -->
                        <div class="wmpr-loading-placeholder">
                            <div class="aui-page-panel">
                                <div class="aui-page-panel-inner">
                                    <div class="aui-page-panel-content">
                                        <div style="text-align: center; padding: 40px;">
                                            <aui-spinner size="medium"></aui-spinner>
                                            <p>Initializing WMPR Settings...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        (function() {
            // Set up proper context path for project admin
            var contextPath = '$req.contextPath';
            var projectKey = '$projectKey';
            
            // Set global context
            window.contextPath = contextPath || '';
            window.projectKey = projectKey || '';
            
            // Ensure AJS is available
            if (typeof AJS === 'undefined') {
                window.AJS = { 
                    contextPath: function() { 
                        return window.contextPath; 
                    } 
                };
            }
            
            console.log('WMPR Settings loaded for project:', window.projectKey);
            console.log('Context path:', window.contextPath);
            
            // Initialize WMPR Settings component
            function initializeWMPRSettings() {
                console.log('Initializing WMPR Settings in project admin context...');
                
                var container = document.getElementById('wmpr-settings-container');
                if (!container) {
                    console.log('Settings container not found, retrying...');
                    setTimeout(initializeWMPRSettings, 1000);
                    return;
                }
                
                if (typeof window.WMPRSettings !== 'undefined' && window.WMPRSettings.mount) {
                    console.log('Mounting WMPR Settings component');
                    window.WMPRSettings.mount();
                } else {
                    console.log('WMPRSettings not ready, retrying...');
                    setTimeout(initializeWMPRSettings, 1000);
                }
            }
            
            // Initialize when ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeWMPRSettings);
            } else {
                setTimeout(initializeWMPRSettings, 100);
            }
            
            // AJS ready
            if (typeof AJS !== 'undefined' && AJS.toInit) {
                AJS.toInit(initializeWMPRSettings);
            }
            
        })();
    </script>

    <script type="text/javascript">
        // Initialize project admin navigation
        (function() {
            function initProjectNavigation() {
                // Trigger Jira's project config navigation
                if (typeof JIRA !== 'undefined' && JIRA.Project && JIRA.Project.Config) {
                    JIRA.Project.Config.init();
                } else if (typeof AJS !== 'undefined' && AJS.ProjectConfigInit) {
                    AJS.ProjectConfigInit();
                }
                
                // Alternative approach: trigger navigation load via DOM manipulation
                var navPanel = document.getElementById('project-config-panel-nav');
                if (navPanel && typeof AJS !== 'undefined') {
                    // Add project context
                    navPanel.setAttribute('data-project-key', '$projectKey');
                    
                    // Trigger project config navigation rendering
                    if (AJS.$(navPanel).length > 0) {
                        AJS.$(document).trigger('project-config-ready', {
                            projectKey: '$projectKey',
                            panel: navPanel
                        });
                    }
                }
            }
            
            // Initialize when ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initProjectNavigation);
            } else {
                setTimeout(initProjectNavigation, 100);
            }
            
            // AJS ready
            if (typeof AJS !== 'undefined' && AJS.toInit) {
                AJS.toInit(initProjectNavigation);
            }
        })();
    </script>
</body>
</html> 